Forest Park Trail Runs
======================
Map trail running routes through [Forest Park](http://www.portlandoregon.gov/parks/finder/index.cfm?&propertyid=127&action=ViewPark).

Last updated `r paste(Sys.time())` using `r R.version$version.string`.


Load packages.

```{r}
packages <- c("RCurl", "plotKML", "geosphere", "ggmap", "ggplot2", "RColorBrewer", "data.table")
sapply(packages, require, character.only=TRUE, quietly=TRUE)
```


Read coordinates for Forest Park waypoints.

```{r, }
url <- getURL("https://docs.google.com/spreadsheet/pub?key=0ApyhYsT8Gi-EdFBUYk4wb0UyYlUweHg1SHlfX3VHV1E&single=true&gid=1&output=csv", cainfo = system.file("CurlSSL", "cacert.pem", package = "RCurl"))
dfWaypoints <- read.csv(textConnection(url), header=TRUE)
dfWaypoints
```

Find the geographic mean of the waypoints. Use the geographic mean as a center point for grabbing the map.

```{rmapForestParkBare}
geomeanFP <- geomean(dfWaypoints[!is.na(dfWaypoints$lon) & !is.na(dfWaypoints$lat), c("lon", "lat")])
geomeanFP
mapFP <- get_map(location=geomeanFP, maptype="terrain", source="stamen", zoom=12)
ggmap(mapFP)
```

Plot the waypoints to use to identify if a run occurred inside Forest Park.

```{r mapForestParkWaypoints}
color <- brewer.pal(9, "PiYG")[1]
g <- ggmap(mapFP, base_layer=ggplot(dfWaypoints, aes(x=lon, y=lat)))
g <- g + geom_point(color=color, size=2)
g
```

Use my running history as a starting point. *Will eventually want to get other runners' data.*

Get files names of GPX data files.

```{r}
path <- file.path("Data", "user001")
files <- dir(path=path, pattern = "\\.gpx")
```

Determine which ones are runs versus rides. Only use the runs for now.

```{r}
isRun <- grepl("run", tolower(files))
isRide <- grepl("ride", tolower(files))
table(isRun, isRide)
files <- files[isRun]
```

Set the date range. Use only the files within range. The dates of the files are determined from the file names.

```{r}
dateFrom <- as.Date("2012-01-01")
dateTo <- Sys.Date()
dates <- as.Date(substr(files, 1, 8), format="%Y%m%d")
isRangeDate <- dateFrom < dates & dates < dateTo
files <- files[isRangeDate]
message(sprintf("Reading %.0d routes run from %s to %s", length(files), dateFrom, dateTo))
```

Consolidate routes in one data frame.

```{r}
index <- c()
date <- c()
lat <- c()
lon <- c()
for (i in 1:length(files)) {
  f <- file.path(path, files[i])
  route <- readGPX(f)
  location <- route$tracks[[1]][[1]]
  index <- c(index, rep(i, dim(location)[1]))
  date <- c(date, rep(as.Date(substr(files[i], 1, 8), format="%Y%m%d"), dim(location)[1]))
	lat <- c(lat, location$lat)
	lon <- c(lon, location$lon)
}
routes <- data.frame(cbind(index, date, lat, lon))
```

Cross join the routes with the waypoints. Use the `CJ` function from the data.table package. It has a performance edge over `merge`. Building the data frame from the cross join is the bottleneck, so print out a diagnostic.

```{r}
system.time(lookup <- CJ(rownumRoute=seq(1, nrow(routes)), rownumWaypoint=seq(1, nrow(dfWaypoints))))
system.time(dfCJ <- data.frame(routes[lookup$rownumRoute, ], dfWaypoints[lookup$rownumWaypoint, ]))
```

Calculate distances from waypoints. I'll need to use the `distHaversine` function from the [geosphere](http://www.inside-r.org/packages/cran/geosphere) package. The Haversine algorithm isn't the most accurate, but it is good enough for this purpose.

```{r}
dist <- distHaversine(dfCJ[, c("lon", "lat")], dfCJ[, c("lon.1", "lat.1")])
dfCJ <- data.frame(dfCJ, dist)
```

Set the distance range in meters. Subset routes to those having at least one coordinate point within range from the central point.

```{r}
rangeDist <- 25
aggRoutes <- aggregate(dist ~ index, dfCJ, min)
includedRoutes <- aggRoutes$index[aggRoutes$dist < rangeDist]
routesInRange <- subset(routes, index %in% includedRoutes)
message(sprintf("Plotting %.0d routes within %.0d m of any waypoint (%.1f%% of the %.0d routes)", length(includedRoutes), rangeDist, length(includedRoutes) / length(files) * 100, length(files)))
```

Set titles for map.

```{r}
fmtDate <- "%d-%b-%Y"
title <- sprintf("Forest Park trail runs\n%.0d routes from %s to %s", length(includedRoutes), format(dateFrom, fmtDate), format(dateTo, fmtDate))
```

Set map attributes. Pick an alpha that will distinguish frequently used trails. Pick a color that will contrast nicely with the green of the terrain map.

```{r}
alpha <- 1/4
color <- brewer.pal(9, "PiYG")[1]
size <- 1/4
theme <- theme(axis.text=element_blank(), axis.title=element_blank(), axis.ticks=element_blank())
```

Plot low resolution and high resolution versions of the routes. Only show the low resolution version. The high resolution version is saved for later.

```{r mapForestParkTrailRunsLowRes}
g <- ggmap(mapFP, base_layer=ggplot(routesInRange, aes(x=lon, y=lat, group=index)))
g <- g + geom_path(alpha=alpha, color=color, size=size)
g <- g + labs(title=title) + theme
g
```

```{r mapForestParkTrailRunsHiRes, dpi=600, fig.height=7, fig.width=7, fig.show='hide'}
g <- ggmap(mapFP, base_layer=ggplot(routesInRange, aes(x=lon, y=lat, group=index)))
g <- g + geom_path(alpha=alpha, color=color, size=size)
g <- g + labs(title=title) + theme
g
```
